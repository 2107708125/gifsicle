PACKAGE		= gifsicle
VERSION		= @VERSION@

.SUFFIXES:
.SUFFIXES: .c .o

.c.o:
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $<

SHELL		= /bin/sh
prefix		= @prefix@
exec_prefix	= @exec_prefix@
VPATH		= @srcdir@
srcdir		= @srcdir@
bindir		= @bindir@
mandir		= @mandir@/man$(manext)
manext		= 1

CC		= @CC@ $(PROFILING)
CCLINKER	= @CC@ $(PROFILING)
CFLAGS		= @CFLAGS@
CPPFLAGS	= @DEFS@ -I.
X_CPPFLAGS	= @X_CFLAGS@
PROFILING	= 
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@
X11LIBS		= @X_LIBS@ @X_PRE_LIBS@ -lX11 @X_EXTRA_LIBS@

INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
INSTALL_DATA	= @INSTALL_DATA@
mkinstalldirs	= $(SHELL) $(srcdir)/mkinstalldirs
PROG_TRANSFORM	= @program_transform_name@

PROGRAMS	= @PROGRAMS@
GIFVIEWOBJS	= gifread.o giffunc.o gifunopt.o gifx.o clp.o @MALLOC_O@ \
		gifview.o
GIFSICLEOBJS	= gifread.o giffunc.o gifwrite.o gifunopt.o clp.o \
		merge.o support.o quantize.o optimize.o @MALLOC_O@ gifsicle.o
GIFDIFFOBJS	= gifread.o giffunc.o clp.o @MALLOC_O@ gifdiff.o

all: $(PROGRAMS)

gifsicle: $(GIFSICLEOBJS)
	$(CCLINKER) $(CFLAGS) -o gifsicle $(GIFSICLEOBJS) $(LDFLAGS) $(LIBS)
gifsicle.o: gifsicle.c
	$(CC) -DVERSION=\"$(VERSION)\" $(CPPFLAGS) $(CFLAGS) -c $<

gifview: $(GIFVIEWOBJS)
	$(CCLINKER) $(CFLAGS) -o gifview $(GIFVIEWOBJS) $(LDFLAGS) $(X11LIBS) $(LIBS)
gifx.o: gifx.c
	$(CC) $(X_CPPFLAGS) $(CPPFLAGS) $(CFLAGS) -c $<
gifview.o: gifview.c
	$(CC) -DVERSION=\"$(VERSION)\" $(X_CPPFLAGS) \
	$(CPPFLAGS) @GETTIMEOFDAY@ $(CFLAGS) -c $<

gifdiff: $(GIFDIFFOBJS)
	$(CCLINKER) $(CFLAGS) -o gifdiff $(GIFDIFFOBJS) $(LDFLAGS) $(LIBS)
gifdiff.o: gifdiff.c
	$(CC) -DVERSION=\"$(VERSION)\" $(CPPFLAGS) $(CFLAGS) -c $<

install: @INSTALLERS@
install-gifsicle: gifsicle
	$(mkinstalldirs) $(bindir) $(mandir)
	$(INSTALL_PROGRAM) gifsicle $(bindir)/`echo gifsicle|sed '$(PROG_TRANSFORM)'`
	$(INSTALL_DATA) $(srcdir)/gifsicle.man $(mandir)/`echo gifsicle|sed '$(PROG_TRANSFORM)'`.$(manext)
install-gifview: gifview
	@$(mkinstalldirs) $(bindir) $(mandir)
	$(INSTALL_PROGRAM) gifview $(bindir)/`echo gifview|sed '$(PROG_TRANSFORM)'`
	$(INSTALL_DATA) $(srcdir)/gifview.man $(mandir)/`echo gifview|sed '$(PROG_TRANSFORM)'`.$(manext)
install-gifdiff: gifdiff
	@$(mkinstalldirs) $(bindir) $(mandir)
	$(INSTALL_PROGRAM) gifdiff $(bindir)/`echo gifdiff|sed '$(PROG_TRANSFORM)'`
	$(INSTALL_DATA) $(srcdir)/gifdiff.man $(mandir)/`echo gifdiff|sed '$(PROG_TRANSFORM)'`.$(manext)

uninstall:
	for i in $(PROGRAMS) ; do \
	rm -f $(bindir)/`echo $$i|sed '$(PROG_TRANSFORM)'` ; \
	rm -f $(mandir)/`echo $$i|sed '$(PROG_TRANSFORM)'`.$(manext) ; \
	done

clp.o: clp.c clp.h

giffunc.o: giffunc.c gif.h
gifread.o: gifread.c gif.h
gifwrite.o: gifwrite.c gif.h
gifunopt.o: gifunopt.c gif.h
gifx.o: gifx.c gifx.h gif.h

gifsicle.o: gifsicle.c gifsicle.h
merge.o: merge.c gifsicle.h
support.o: support.c gifsicle.h
quantize.o: quantize.c gifsicle.h
	$(CC) -DRANDOM=@RANDOM_FUNC@ $(CPPFLAGS) $(CFLAGS) -c $<
optimize.o: optimize.c gifsicle.h

srclinks:
	for i in clp.c clp.h ; do \
	ln -s ../edlib/$$i $$i ; done
	for i in gif.h.in giffunc.c gifread.c gifwrite.c gifunopt.c \
	gifx.h gifx.c giftoc.c ; do \
	ln -s ../giflib/$$i $$i ; done

versionize:
	perl -pi~ -e "s/^\\.ds V.*/.ds V $(VERSION)/;" gifsicle.man gifview.man gifdiff.man
	perl -pi~ -e "s/^Version: .*/Version: $(VERSION)/; s/$(PACKAGE)-[\w.]+\.tar\.gz/$(PACKAGE)-$(VERSION).tar.gz/;" rpm.spec

#####
# Cleaning and distribution

clean:
	rm -f $(PROGRAMS) *.o core *.core
mostlyclean: clean
distclean: mostlyclean
	rm -f Makefile gif.h config.status config.log config.cache
realclean: distclean

$(PACKAGE)-$(VERSION).tar.gz:
	rm -rf $(PACKAGE)-$(VERSION)
	mkdir -m 0777 $(PACKAGE)-$(VERSION)
	cp INSTALL Makefile.in NEWS README configure configure.in \
	install-sh mkinstalldirs \
	gif.h.in gifread.c gifwrite.c giffunc.c gifunopt.c \
	clp.c clp.h dmalloc.c dmalloc.h fmalloc.c \
	gifsicle.h merge.c support.c quantize.c optimize.c gifsicle.c \
	gifx.h gifx.c gifview.c gifsicle.man gifview.man \
	gifdiff.c gifdiff.man \
	logo.gif logo1.gif rpm.spec \
	$(PACKAGE)-$(VERSION)
	gtar czf $(PACKAGE)-$(VERSION).tar.gz $(PACKAGE)-$(VERSION)
	rm -r $(PACKAGE)-$(VERSION)
dist:
	@rm -f $(PACKAGE)-$(VERSION).tar.gz
	@make $(PACKAGE)-$(VERSION).tar.gz

rpm: $(PACKAGE)-$(VERSION).tar.gz
	buildarch=`rpm --showrc | awk '/^build arch/ { print $$4; }'` ; \
	mkdir -p /tmp/rpmb/SOURCES /tmp/rpmb/RPMS/$$buildarch \
	/tmp/rpmb/BUILD ; \
	echo 'topdir: /tmp/rpmb' > /tmp/rpmb/rc ; \
	cp logo1.gif $(PACKAGE)-$(VERSION).tar.gz /tmp/rpmb/SOURCES ; \
	rpm --rcfile /tmp/rpmb/rc -bb rpm.spec ; \
	cp /tmp/rpmb/RPMS/$$buildarch/*.rpm .
	rm -rf /tmp/rpmb

.PHONY: all install install-gifsicle install-gifview install-gifdiff \
	uninstall srclinks versionize dist rpm \
	clean mostlyclean distclean realclean
